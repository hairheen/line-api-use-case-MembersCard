AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'UseCase-Batch

  '
Globals:
  Function:
    MemorySize: 128
    Timeout: 30
Parameters:
  Environment:
    Type: String
    AllowedValues:
    - dev
    - prod
    Default: dev
Mappings:
  EnvironmentMap:
    dev:
      LINEChannelAccessTokenDBName: LineChannelAccessDBDev
      EventBridgeName: LineEventBridgeDev
      LayerVersion: 6
      LoggerLevel: DEBUG
    prod:
      LINEChannelAccessTokenDBName: LineChannelAccessDBProd
      EventBridgeName: LineEventBridgeProd
      LayerVersion: 6
      LoggerLevel: DEBUG
Resources:
  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: sts:AssumeRole
          Principal:
            Service:
            - lambda.amazonaws.com
      Policies:
      - PolicyName: CloudWatchAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: logs:PutLogEvents
            Resource:
              Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/MembersCard-*:*:*
          - Effect: Allow
            Action:
            - logs:CreateLogStream
            Resource:
            - Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/MembersCard-*:*
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - ssm:GetParameters
            Resource: '*'
      - PolicyName: DynamoTableAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - dynamodb:GetItem
            - dynamodb:Query
            - dynamodb:UpdateItem
            - dynamodb:Scan
            - dynamodb:PutItem
            - logs:CreateLogStream
            Resource:
            - Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/MembersCard-*:*
            - Fn::GetAtt:
              - LINEChannelAccessTokenDB
              - Arn
      RoleName:
        Fn::Sub: ${AWS::StackName}-LambdaRole
  LINEChannelAccessTokenDB:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: channelId
        AttributeType: S
      TableName:
        Fn::FindInMap:
        - EnvironmentMap
        - Ref: Environment
        - LINEChannelAccessTokenDBName
      SSESpecification:
        SSEEnabled: true
      KeySchema:
      - AttributeName: channelId
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
  PutAccessToken:
    Type: AWS::Serverless::Function
    Properties:
      Handler: update_line_access_token.lambda_handler
      Runtime: python3.8
      CodeUri: PutAccessToken
      FunctionName:
        Fn::Sub: MembersCard-PutAccessToken-${Environment}
      Description: ''
      Layers:
      - Fn::Join:
        - ':'
        - - Fn::Sub: arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:layer
          - Fn::ImportValue: MembersCardLayerDev
          - Fn::FindInMap:
            - EnvironmentMap
            - Ref: Environment
            - LayerVersion
      Role:
        Fn::GetAtt:
        - LambdaRole
        - Arn
      Environment:
        Variables:
          LOGGER_LEVEL:
            Fn::FindInMap:
            - EnvironmentMap
            - Ref: Environment
            - LoggerLevel
          CHANNEL_ACCESS_TOKEN_DB:
            Fn::FindInMap:
            - EnvironmentMap
            - Ref: Environment
            - LINEChannelAccessTokenDBName
    Metadata:
      SamResourceId: PutAccessToken
  EventBridge:
    Type: AWS::Events::Rule
    Properties:
      Description: Check&Update for ShortTermAccessToken
      Name:
        Fn::FindInMap:
        - EnvironmentMap
        - Ref: Environment
        - EventBridgeName
      ScheduleExpression: cron(0 0 * * ? *)
      State: ENABLED
      Targets:
      - Arn:
          Fn::GetAtt:
          - PutAccessToken
          - Arn
        Id: TargetFunctionV1
  PutAccessTokenFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: PutAccessToken
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
        - EventBridge
        - Arn
Outputs:
  LINEChannelAccessTokenDB:
    Description: DynamoDB ARN for LINEChannelAccessToken
    Value:
      Fn::GetAtt:
      - LINEChannelAccessTokenDB
      - Arn
